---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Lista de Proyectos">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>üìã Todos los Proyectos</h1>
    <a href="/nuevo" class="btn">‚ûï Nuevo Proyecto</a>
  </div>

  <div class="card" style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem;">üîç Filtros y B√∫squeda</h3>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <div>
        <label for="search">Buscar</label>
        <input type="text" id="search" placeholder="T√≠tulo o descripci√≥n...">
      </div>

      <div>
        <label for="estado">Estado</label>
        <select id="estado">
          <option value="">Todos los estados</option>
          <option value="idea">Idea</option>
          <option value="prototipo">Prototipo</option>
          <option value="en_progreso">En Progreso</option>
          <option value="bloqueado">Bloqueado</option>
          <option value="pausado">Pausado</option>
          <option value="completado">Completado</option>
          <option value="archivado">Archivado</option>
        </select>
      </div>

      <div>
        <label for="prioridad">Prioridad m√≠nima</label>
        <select id="prioridad">
          <option value="">Cualquiera</option>
          <option value="1">1 o m√°s</option>
          <option value="3">3 o m√°s</option>
          <option value="5">5 o m√°s</option>
          <option value="7">7 o m√°s</option>
        </select>
      </div>

      <div style="display: flex; align-items: flex-end;">
        <button class="btn" onclick="aplicarFiltros()" style="width: 100%;">
          Buscar
        </button>
      </div>
    </div>
  </div>

  <div id="loading" style="text-align: center; padding: 2rem;">
    Cargando proyectos...
  </div>

  <div id="proyectos-lista"></div>

  <style>
    .proyecto-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .proyecto-item:hover {
      border-color: var(--accent-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .proyecto-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .proyecto-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .proyecto-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }
  </style>

  <script>
    const API_URL = 'http://localhost:8000';

    async function loadProyectos(filters = {}) {
      try {
        const params = new URLSearchParams();
        if (filters.estado) params.append('estado', filters.estado);
        if (filters.prioridad_min) params.append('prioridad_min', filters.prioridad_min);
        if (filters.search) params.append('search', filters.search);

        const url = `${API_URL}/projects?${params.toString()}`;
        const response = await fetch(url);
        const proyectos = await response.json();

        document.getElementById('loading')!.style.display = 'none';

        const container = document.getElementById('proyectos-lista')!;

        if (proyectos.length === 0) {
          container.innerHTML = `
            <div class="no-results">
              <h3>No se encontraron proyectos</h3>
              <p>Intenta ajustar los filtros o crea un nuevo proyecto</p>
            </div>
          `;
          return;
        }

        container.innerHTML = proyectos.map((proyecto: any) => {
          const fecha = new Date(proyecto.fecha_creacion).toLocaleDateString('es-ES');

          return `
            <div class="proyecto-item" onclick="window.location.href='/proyecto/${proyecto.id}'">
              <div class="proyecto-header">
                <div>
                  <h3 class="proyecto-title">${proyecto.titulo}</h3>
                  <div class="proyecto-meta">
                    <span>ID: ${proyecto.id}</span>
                    <span>Prioridad: ${proyecto.prioridad}</span>
                    <span>Creado: ${fecha}</span>
                  </div>
                </div>
                <span class="badge badge-${proyecto.estado}">${proyecto.estado.replace('_', ' ')}</span>
              </div>
              ${proyecto.descripcion ? `
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                  ${proyecto.descripcion.substring(0, 200)}${proyecto.descripcion.length > 200 ? '...' : ''}
                </p>
              ` : ''}
              ${proyecto.etiquetas && proyecto.etiquetas.length > 0 ? `
                <div style="margin-top: 0.75rem;">
                  ${proyecto.etiquetas.map((tag: any) => `
                    <span style="display: inline-block; padding: 0.25rem 0.5rem; background: ${tag.color || '#e5e7eb'}; color: #374151; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem;">
                      ${tag.nombre}
                    </span>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error al cargar proyectos:', error);
        document.getElementById('loading')!.innerHTML = '‚ùå Error al cargar proyectos. Verifica que el backend est√© ejecut√°ndose.';
      }
    }

    // Funci√≥n global para aplicar filtros
    (window as any).aplicarFiltros = function() {
      const filters: any = {};

      const search = (document.getElementById('search') as HTMLInputElement).value;
      const estado = (document.getElementById('estado') as HTMLSelectElement).value;
      const prioridad = (document.getElementById('prioridad') as HTMLSelectElement).value;

      if (search) filters.search = search;
      if (estado) filters.estado = estado;
      if (prioridad) filters.prioridad_min = prioridad;

      loadProyectos(filters);
    };

    // Cargar proyectos al inicio
    loadProyectos();

    // Permitir b√∫squeda con Enter
    document.getElementById('search')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        (window as any).aplicarFiltros();
      }
    });
  </script>
</Layout>
